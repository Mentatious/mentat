- include: preprocess.yaml

- hosts: localhost
  gather_facts: no

  tasks:
    - include_vars: common_vars.yml

    # TODO: exclude Quicklisp, see:
    # https://www.darkchestnut.com/2016/dont-put-quicklisp-in-your-binary-just-because-a-library-demands-it/
    # https://www.darkchestnut.com/2016/keep-quicklisp-and-qlot-out-of-your-application-binary/
    - name: build xmpp binary
      shell: "sbcl --eval \"(ql:quickload 'mentat)\" --eval \"(mentat::save-image-xmpp-bot)\""

- hosts: botservers
  gather_facts: no

  tasks:
    - include_vars: common_vars.yml

    - name: remove old xmpp remote binary
      file:
        path=/home/{{ username }}/{{ xmpp_binary_name }}
        state=absent

    - name: copy compiled xmpp binary to remote server
      copy: src=../deploy/{{ xmpp_binary_name }} dest=/home/{{ username }}

    - name: copy xmpp logrotate config to remote server
      copy:
        src=../conf/mentat-xmpp-bot.logrotate
        dest=/etc/logrotate.d/mentat-xmpp-bot
        mode=0644
      become: yes

    - name: set xmpp binary attrs
      file: path=/home/{{ username }}/{{ xmpp_binary_name }} mode=u+rwx

    - name: restart mentat-xmpp service on remote server
      supervisorctl: name=mentat-xmpp state=restarted
      become: yes

- hosts: localhost

  tasks:
    - name: cleanup recently built binary
      file: path=./mentat-xmpp-bot state=absent

- include: postprocess.yaml
